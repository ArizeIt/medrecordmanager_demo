@model MedRecordManager.Models.UserRecord.UserVm
@{
    ViewData["Title"] = "ManageUser";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section scripts{

    <script type="text/javascript">
        var userGrid;

        $(document).ready(function () {

            var editManager = function (value, record, $cell, $displayEl, id, $grid) {
                var
                    $edit = $('<button type="button"class="btn btn-warning">Edit</button>').attr('data-key', id),
                    $update = $('<button type="button"class="btn btn-success">Update</button><span style="padding-right: 5px"/>').attr('data-key', id).hide(),
                    $cancel = $('<button type="button"class="btn btn-default">Cancel</button>').attr('data-key', id).hide();
                    $delete = $('<button type="button"class="btn btn-danger">Delete</button><span style="padding-right: 5px"/>').attr('data-key', id)


                
                $edit.on('click', function (e) {
                    $grid.edit($(this).data('key'));
                    $edit.hide();
                   
                    $update.show();
                    $cancel.show();
                });
                $update.on('click', function (e, id, record) {
                    $grid.update($(this).data('key'));
                    $edit.show();
                    
                    $update.hide();
                    $cancel.hide();
                });

                $cancel.on('click', function (e) {
                    $grid.cancel($(this).data('key'));
                    $edit.show();
                  
                    $update.hide();
                    $cancel.hide();
                });

                $delete.on('click', function (e) {
                    deleteUser($(this).data('key'))
                });

                $displayEl.empty().append($delete).append($edit).append($update).append($cancel);
            };

            usergedGrid = $('#userTable').grid({
                primaryKey: 'userId',
                dataSource: '/UserAdmin/getusers',
                columns: [
                    { filed: 'userId', hidden: true },
                    { field: 'firstName', Width: 300, title: 'First Name' },
                    { field: 'lastName', Width: 300, title: 'Last Name' },
                    { field: 'email', Width: 150, title: 'User Name' },
                    { field: 'phone', minwidth: 100, title: 'Phone number' },
                    { field: 'roles', minwidth: 80, title: 'Assigned Roles' },
                    { field: 'companies', minwidth: 80, title: 'Assigned Companys' },
                    { field: 'offices', minWidth: 100, title: 'Assigned Offices' },
                    { field: 'clinics', minWidth: 100, title: 'Assigned Clinics' },
                    { field: 'Actions', width: 200, renderer: editManager, align: 'center' }
                ],
                pager: { limit: 10, sizes: [2, 5, 10, 20] },
            });

            $('#addUser').on('click', function () {

                var uid = $("#userEmail").val();
                var fistName = $('#userFirstName').val();
                var lastName = $('#userLasttName').val();

                if (uid != 0) {
                    $.ajax({
                        url: '/UserAdmin/AddNewUser',
                        type: 'post',
                        data: {
                            email: uid,
                            firstname: fistName,
                            lastname: lastName
                        },
                        dataType: "json",
                        success: function (response) {
                            if (response.success) {
                                $('#modalUser').modal('hide');
                                $('body').removeClass('modal-open');
                                $('.modal-backdrop').remove();
                                CptCodeGrid.reload();
                            } else {
                                $('#addUserMsg').empty().append("<div class='alert alert-danger' role='alert'>" + response.responseText + "</div>");
                            }
                        },
                        error: function (response) {
                            $('#addUserMsg').empty().append("<div class='alert alert-danger' role='alert'>Server error, record is not saved.</div>");
                        }
                    });
                }
                else {
                    $('#addUserMsg').empty().append("<div class='alert alert-danger' role='alert'>Email field can not be empty.</div>");
                }
            });

            function deleteUser(id) {
                
                $.ajax({
                    type: "DELETE",
                    data: {
                        userName: id
                    },
                    url: "/UserAdmin/DeleteUser",
                    cache: false,
                    success: function () {
                        usergedGrid.reload();
                    }
                });              
            }

        });
    </script>
}

<div class="alert alert-warning" id="userMsg" hidden>
    <strong>Warning!</strong>
</div>
<h1>User Manager</h1>

<div class="row top-buffer">
    <div class="col-md-12">
        <div class="box box-widget">
            <div class="box-header with-border">
                <h3 class="box-title">user Filters</h3>
            </div>
            <div class="box-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="@Model.Filter.Company" control-label">Company</label>
                            <select class="form-control" asp-for="@Model.Filter.Company" , asp-items="@Model.Filter.Companies" id="userCompany" multiple></select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="@Model.Filter.OfficeKey" class="control-label">Office Key</label>
                            <select class="form-control" asp-for="@Model.Filter.OfficeKey" , asp-items="@Model.Filter.OfficeKeys" id="userOfficeKey" multiple></select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="@Model.Filter.Clinic" class="control-label">Clinc</label>
                            <select class="form-control" asp-for="@Model.Filter.Clinic" , asp-items="@Model.Filter.Clinics" id="userClinc" multiple></select>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <div class="control-group">
                                <div style="margin-top: 24px;">
                                    <input type="button" value="Filter" class="btn btn-primary" id="filterButton" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>  

@if(@Model.HasError)
{
<div class="alert alert-warning" id="globalmsg">
    <strong>ERROR!</strong> There is some thing wrong, please go back and fix the error.
</div>
}

<div class="row top-buffer">
    <div class="col-md-12">
        <div class="box box-warning">
            <div class="box-header with-border">
                <h3 class="box-title">Curret User Records</h3>
            </div>
            <div class="box-body">
                <div class="row">
                    <div class="col-xs-12">
                        <button type="button" class="btn btn-success pull-right" id="btnAddUser" data-toggle="modal" data-target="#modalUser">Add User</button>
                    </div>
                </div>
                <div class="row" style="margin-top: 10px">
                    <div class="col-xs-12">
                        <div class="table-responsive">
                            <table id="userTable" class="table table-striped"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modalUser" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h4 class="modal-title w-100 font-weight-bold">Add New User</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <form asp-controller="UserAdmin" , asp-action="AddNewUser" method="post">
                
                <div asp-validation-summary="All" class="text-danger"></div>
                <div class="modal-body mx-3">
                    <div id="addUserMsg" class="modalmsg"></div>
                    <div class="md-form mb-5">
                        <div class="form-group">
                            <label data-error="wrong" data-success="right" asp-for="FirstName">First Name</label>
                            <input type="text" class="form-control validate" asp-for="FirstName">
                            <span asp-validation-for="FirstName" class="text-danger"></span>
                        </div>

                    </div>

                    <div class="md-form mb-5">
                        <div class="form-group">
                            <label data-error="wrong" data-success="right" asp-for="LastName">Last Name</label>
                            <input type="text"  class="form-control validate" asp-for="LastName">
                            <span asp-validation-for="LastName" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="md-form mb-5">
                        <div class="form-group">
                            <label data-error="wrong" data-success="right" asp-for="Email">Email</label>
                            <input type="email"  class="form-control validate" asp-for="Email">
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="md-form mb-5">
                        <div class="form-group">
                            <label data-error="wrong" data-success="right" asp-for="Password">Password</label>
                            <input type="password"  class="form-control validate" asp-for="Password">
                            <span asp-validation-for="Password" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="md-form mb-5">
                        <div class="form-group">
                            <label data-error="wrong" data-success="right" asp-for="ConfirmPassword">ConfirmPassword</label>
                            <input type="password" class="form-control validate" asp-for="ConfirmPassword">
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn form-control btn-primary">Add</button>
                </div>
             </form>
        </div>
    </div>
</div>

