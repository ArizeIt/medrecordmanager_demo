@model MedRecordManager.Models.SearchInputs
@{
    ViewData["Title"] = "Record Manager - Daily Review";
}

@section scripts{
    <script type="text/javascript">

        var dailyGrid;
        var patientGrid;
        var payerGrid;
        var guarantorGrid;

       
        $(document).ready(function () {
            var type = $('#searchType').val();
            var detailButtonRender = function (value, record, $cell, $displayEl) {
                var $btn = $('<button type="button" class="btn btn-danger btnDetail">Detail</button>').on('click', function () {
                    addTab(record.visitId);
                    //$.ajax({
                    //    type: "GET",
                    //    data: {
                    //        visitId: record.visitId
                    //    },
                    //    url: "/Record/GetDetails",
                    //    dataType: 'json',
                    //}).done(function (response) {
                    //    $('#Results').html(response);
                    //});
                });
                if ($displayEl.children().length == 0) {
                    $displayEl.append($btn);
                }
                
            };
            if (type == 'Daily') {
                dailyGrid = $('#visitTable').grid({
                    primaryKey: 'visitId',
                    inlineEditing: { mode: 'dblclick' },
                    dataSource: '/Record/LoadDaily',
                    uiLibrary: 'materialdesign',
                    columnReorder: true,

                    columns: [
                        { field: 'pvRecordId', hidden: true },
                        { field: 'patientId', hidden: true },
                        { filed: 'visitId', hidden: true },
                        { field: 'patientName', minWidth: 250, title: 'Patient Name', editor: true },
                        { field: 'clinicName', minWidth: 150, title: 'Clinic Name', type: 'dropdown', editor: { dataSource: '/Record/GetClinic', valueField: 'id' }, editField: 'clinicName' },
                        { field: 'pvFinClass', width:100, title: 'Finacial Class' },
                        { field: 'payment $', width: 100, title: 'Payment'},
                        { field: 'diagCode', width: 150,title: 'Diag Codes' },
                        { field: 'icdCodes', width: 150,title: 'Icd Codes' },
                        { field: 'procCodes', width: 150,title: 'Proc Codes' },
                        { field: 'visitTime', width: 100, title: 'Visit Date' },
                        { field: 'Action', width:100, renderer: detailButtonRender }
                    ],
                    pager: { limit: 10, sizes: [2, 5, 10, 20] },
                    detailTemplate: '<div><table/></div>'
                });

                dailyGrid.on('detailExpand', function (e, $detailWrapper, id) {
                    $detailWrapper.find('table').grid({
                        params: { visitId: id },
                        dataSource: '/Record/Payer',
                        autoGenerateColumns: true
                    });
                });

                dailyGrid.on('detailCollapse', function (e, $detailWrapper, id) {
                    $detailWrapper.find('table').grid('destroy', true, true);
                });
            }
            else if (type == 'Callback') {
                dailyGrid = $('#visitTable').grid({
                    primaryKey: 'pvId',
                    inlineEditing: { mode: 'dblclick' },
                    dataSource: '/Record/LoadCallback',
                    uiLibrary: 'bootstrap',
                    columns: [
                        { field: 'pvId', hidden: true },
                        { field: 'patientName' },
                        { field: 'pvClinic' },
                        { field: 'visitDate' },
                        { field: 'pvPhone', title: 'Phone No.', editor: true },
                        { field: 'pvPhoneType', title: 'Type', editor: true },
                        { field: 'cellPhone', editor: true }
                    ],
                    pager: { limit: pagelimit, sizes: pagesize }
                });

            }

            patientGrid = $('#patientGrid').grid({
                primaryKey: 'PvPaitentId',
                datasource: '/record/GetPatientDetail',
                uiLibrary: 'bootstrap',
            });

            payerGrid = $('#payerGrid').grid({
                primaryKey: 'PvPaitentId',
                datasource: '/record/GetPatientDetail',
                uiLibrary: 'bootstrap',
            });

            guarantorGrid = $('#guarantorGrid').grid({
                primaryKey: 'PvPaitentId',
                datasource: '/record/GetPatientDetail',
                uiLibrary: 'bootstrap',
            });


            $('#startDate').datepicker({
                uiLibrary: 'bootstrap'
            });

            $('#endDate').datepicker({
                uiLibrary: 'bootstrap'
            });

            $('#searchButton').on('click', function () {
                var type = $('#searchType').val();

                if (type === 'Daily') {
                    var keys = [];
                    $('#officeKey > Option:selected').each(function () {
                        keys.push(this.value);
                    })
                    dailyGrid.clear();
                    dailyGrid.reload({ office: keys.join(','), startDate: $('#startDate').val(), endDate: $('#endDate').val() });
                }

                else if (type === 'Callback') {
                    dailyGrid.clear();
                    dailyGrid.reload({ office: $('#officeKey').val(), startDate: $('#startDate').val(), endDate: $('#endDate').val() });
                }

                $('#dataView').show();
            });


            $('#btnRun').click(function () {
                $('#btnRun').attr('disabled', true);
                $.ajax({
                    url: 'http://172.31.22.98/api/default',
                    data: {
                        officeKey:"",
                        startDate: $('#startDate').val(),
                        endDate: $('#endDate').val()
                    },
                    type: 'Post',
                    success: function (response) {
                        $('#btnRun').attr('disabled', false);
                    },
                    dataType:'json'
                })
            })

             //$('.nav-tab').on('click', "a", function (e) {
            //    e.preventDefault();

            //}).on('click', 'span', function () {
            //    var anchor = $(this).siblings('a');
            //    $(anchor.attr('href')).remove();
            //    $(this).parent().remove();
            //   $(".nav-tabs li").children('a').first().click();
            // });
            function addTab(id) {
                $('.nav-tabs').find('li').last().after('<li><a data-toggle="tab" href="#detail' + id + '"><b>Visit ' + id + '</b></a></li>');
                 $.ajax({
                        type: "GET",
                        data: {
                            visitId: id
                        },
                        url: "/Record/GetDetails",
                        dataType: 'json',
                    }).done(function (response) {
                        $('.tab-content').append(response);
                    }); 
                $(".nav-tabs li").children('a').last().click();
                
            }
           

            
        });

    </script>

}

    <ul class="nav nav-tabs" role="tablist">
        @if (Model.Type == "Daily")
        {
            <li class="active"><a data-toggle="tab" href="#mainView"><b>Daily Review</b></a></li>

        }
        else if (Model.Type == "Callback")
        {
            <li class="active"><a data-toggle="tab" href="#mainView"><b>Call Back</b></a></li>

        }

    </ul>
    <div class="tab-content">
        <div class="tab-pane active" id="mainView">
            <input type="hidden" asp-for="Type" id="searchType" />
            <div class="row">
                <div class="col-sm-2">
                    <div class="form-group">
                        <label asp-for="OfficeKey" class="control-label"> Select Office Key(s)</label>
                        <select class="form-control" asp-for="OfficeKey" , asp-items="@Model.OfficeKeys" id="officeKey" multiple></select>
                    </div>
                </div>

                <div class="col-sm-2">
                    <div class="form-group">
                        <label asp-for="StartDate" class="control-label">Visit Start Date</label>
                        <input class="form-control date" id="startDate" />
                    </div>
                </div>

                <div class="col-sm-2">
                    <div class="form-group">
                        <label asp-for="EndDate" class="control-label">Visit End Date</label>
                        <input class="form-control date" id="endDate" />
                    </div>

                </div>
                <div class="col-sm-1">
                    <div class="form-group">
                        <div class="control-group">
                            <div style="margin-top: 24px;">
                                <input type="button" value="Search" class="btn btn-primary" id="searchButton" />
                            </div>
                        </div>
                    </div>
                </div>

                @if (Model.Type == "Callback")
                {
                    <div class="row">
                        <div class="col-sm-2">
                            <div class="form-group">
                                <label asp-for="Clinic" class="control-label">Select Clinic(s)</label>
                                <select class="form-control" asp-for="Clinic" , asp-items="@Model.Clinics" id="officeKey" multiple></select>
                            </div>
                        </div>
                    </div>

                }
            </div>
            <p></p>
            <div class="row" id="dataView" style="display:none">
                <div class="col-sm-10">
                    <div id="Results">
                        <div class="table-responsive">
                            <table id="visitTable" class="table"></table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-1 " style="float: left">
                    <button class="btn btn-success text-right" id="btnRun">Run</button>
                    </div>
                </div>
            </div>
    </div>
